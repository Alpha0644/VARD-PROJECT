# AUTO-GENERATED by OMEGA v3.0
# Complete CI/CD Pipeline with Quality Gates

name: OMEGA v3.0 CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20'
  
jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # QUALITY GATES (All must pass)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      # GATE 1: Linting
      - name: ğŸ” Lint Check
        run: npm run lint
        continue-on-error: false
      
      # GATE 2: Type Safety
      - name: ğŸ“˜ TypeScript Check
        run: npm run type-check
        continue-on-error: false
      
      # GATE 3: Security Audit
      - name: ğŸ”’ Security Audit
        run: |
          npm audit --production --audit-level=high
        continue-on-error: false
      
      # GATE 4: Secret Scan
      - name: ğŸ” Secret Detection
        run: |
          bash tools/check-secrets.sh
        continue-on-error: false
      
      # GATE 5: Unit Tests
      - name: ğŸ§ª Unit Tests
        run: npm run test:unit
        continue-on-error: false
      
      # GATE 6: Coverage Check
      - name: ğŸ“Š Coverage Check (85% minimum)
        run: |
          npm run test:coverage
          COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.statements.pct')
          echo "Coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 85" | bc -l) )); then
            echo "âŒ Coverage below 85%: $COVERAGE%"
            exit 1
          fi
          echo "âœ… Coverage passed: $COVERAGE%"
      
      # Upload coverage to Codecov
      - name: ğŸ“¤ Upload Coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/coverage-final.json
          flags: unittests
      
      # GATE 7: Build Check
      - name: ğŸ—ï¸ Build
        run: npm run build
        env:
          NEXT_TELEMETRY_DISABLED: 1
      
      # GATE 8: Bundle Size Check
      - name: ğŸ“ Bundle Size Check (500KB max)
        run: |
          SIZE=$(du -sb .next/static | cut -f1)
          SIZE_KB=$((SIZE / 1024))
          echo "Bundle size: ${SIZE_KB}KB"
          if [ $SIZE -gt 512000 ]; then
            echo "âŒ Bundle too large: ${SIZE_KB}KB (max: 500KB)"
            exit 1
          fi
          echo "âœ… Bundle size OK: ${SIZE_KB}KB"
      
      # GATE 9: Performance Budget (Lighthouse CI)
      - name: âš¡ Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            http://localhost:3000
          uploadArtifacts: true
          temporaryPublicStorage: true
          budgetPath: ./lighthouse-budget.json
      
      - name: ğŸ“Š Quality Summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "         QUALITY GATES SUMMARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Lint:       ${{ steps.lint.outcome }}"
          echo "Type Check: ${{ steps.typecheck.outcome }}"
          echo "Security:   ${{ steps.security.outcome }}"
          echo "Tests:      ${{ steps.tests.outcome }}"
          echo "Coverage:   ${{ steps.coverage.outcome }}"
          echo "Build:      ${{ steps.build.outcome }}"
          echo "Bundle:     ${{ steps.bundle.outcome }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # E2E TESTS (Playwright)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: quality-gates
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      - name: ğŸ­ Install Playwright
        run: npx playwright install --with-deps
      
      - name: ğŸ—ï¸ Build application
        run: npm run build
      
      - name: ğŸ§ª Run E2E Tests
        run: npm run test:e2e
  - name: ğŸ“¤ Upload E2E Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-report
          path: playwright-report/
          
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # DEPLOY TO STAGING
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [quality-gates, e2e-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: staging
      url: https://staging.yourdomain.com
    
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸš€ Deploy to Vercel (Staging)
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          scope: ${{ secrets.VERCEL_ORG_ID }}
      
      - name: ğŸ§ª Smoke Tests on Staging
        run: |
          sleep 10 # Wait for deployment
          curl -f https://staging.yourdomain.com/api/health || exit 1
          echo "âœ… Staging health check passed"
  
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # DEPLOY TO PRODUCTION (Manual Approval Required)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://yourdomain.com
    
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸš€ Deploy to Vercel (Production)
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          scope: ${{ secrets.VERCEL_ORG_ID }}
      
      - name: ğŸ”” Notify Deployment Success
        if: success()
        run: |
          echo "âœ… Production deployment successful!"
          # Add Slack/Discord notification here if needed
      
      - name: ğŸš¨ Notify Deployment Failure
        if: failure()
        run: |
          echo "âŒ Production deployment failed!"
          # Add alert notification here

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # AUTO-ROLLBACK ON FAILURE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  auto-rollback:
    name: Auto-Rollback on Failure
    runs-on: ubuntu-latest
    needs: deploy-production
    if: failure()
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: ğŸ”„ Rollback to Previous Version
        run: |
          echo "ğŸš¨ Production deployment failed, rolling back..."
          # Get previous successful deployment
          PREV_DEPLOYMENT=$(vercel ls --token=${{ secrets.VERCEL_TOKEN }} | grep -A 1 "READY" | tail -1)
          # Promote previous deployment to production
          vercel promote $PREV_DEPLOYMENT --token=${{ secrets.VERCEL_TOKEN }} --scope=${{ secrets.VERCEL_ORG_ID }}
          echo "âœ… Rolled back to previous version"
